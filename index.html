<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>WakeStop - Proximity Alarm</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        button, input {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #16213e;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #0f3460;
            flex-shrink: 0;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #e94560;
        }

        .header h1 span {
            color: #eee;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .unit-toggle {
            background: #0f3460;
            border: none;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .unit-toggle.active {
            color: #4ecca3;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #555;
            transition: background 0.3s;
        }

        .status-dot.tracking {
            background: #4ecca3;
            animation: pulse 1.5s infinite;
        }

        .status-dot.alarm {
            background: #e94560;
            animation: pulse 0.4s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Map */
        #map {
            flex: 1;
            z-index: 1;
        }

        /* Search bar */
        .search-container {
            position: absolute;
            top: 60px;
            left: 10px;
            right: 10px;
            z-index: 1000;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            background: rgba(22, 33, 62, 0.95);
            color: #eee;
            font-size: 16px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .search-box::placeholder {
            color: #888;
        }

        .search-results {
            margin-top: 4px;
            background: rgba(22, 33, 62, 0.95);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            font-size: 14px;
        }

        .search-result-item:active {
            background: rgba(233, 69, 96, 0.2);
        }

        /* Favourites bar */
        .favourites-bar {
            position: absolute;
            top: 112px;
            left: 10px;
            right: 10px;
            z-index: 999;
            display: flex;
            gap: 6px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
        }

        .favourites-bar::-webkit-scrollbar {
            display: none;
        }

        .favourites-bar:empty {
            display: none;
        }

        .fav-chip {
            flex-shrink: 0;
            background: rgba(22, 33, 62, 0.9);
            border: 1px solid #0f3460;
            color: #ccc;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fav-chip:active {
            background: rgba(233, 69, 96, 0.2);
        }

        .fav-chip .fav-remove {
            color: #e94560;
            font-weight: 700;
            font-size: 14px;
            line-height: 1;
            padding: 0 2px;
        }

        /* Bottom panel */
        .bottom-panel {
            background: #16213e;
            border-top: 1px solid #0f3460;
            padding: 16px;
            flex-shrink: 0;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        /* Destination info */
        .dest-info {
            display: none;
            background: rgba(15, 52, 96, 0.5);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .dest-info.visible {
            display: block;
        }

        .dest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .dest-name {
            font-size: 14px;
            color: #e94560;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .btn-save-fav {
            background: none;
            border: 1px solid #0f3460;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 6px;
            line-height: 1;
            flex-shrink: 0;
            margin-left: 8px;
        }

        .btn-save-fav.saved {
            color: #e94560;
            border-color: #e94560;
        }

        .dest-distance {
            font-size: 28px;
            font-weight: 700;
            color: #4ecca3;
        }

        .dest-distance .unit {
            font-size: 14px;
            font-weight: 400;
            color: #888;
        }

        /* Radius control */
        .radius-control {
            margin-bottom: 12px;
        }

        .radius-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .radius-label span {
            font-size: 14px;
            color: #888;
        }

        .radius-value {
            font-size: 16px;
            font-weight: 600;
            color: #4ecca3;
        }

        .radius-slider {
            width: 100%;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #0f3460;
            outline: none;
        }

        .radius-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.4);
        }

        .radius-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e94560;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.4);
        }

        /* Quick presets */
        .radius-presets {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .preset-btn {
            flex: 1;
            padding: 6px 0;
            background: #0f3460;
            border: none;
            border-radius: 8px;
            color: #888;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .preset-btn.active {
            background: #e94560;
            color: #fff;
        }

        .preset-btn:active {
            transform: scale(0.95);
        }

        /* Buttons */
        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn-start {
            background: #4ecca3;
            color: #1a1a2e;
        }

        .btn-start:disabled {
            background: #2a5a4a;
            color: #aaa;
        }

        .btn-stop {
            background: #e94560;
            color: #fff;
            display: none;
        }

        .btn-clear {
            background: #0f3460;
            color: #888;
            flex: 0.3;
        }

        .btn-test {
            background: #0f3460;
            color: #e94560;
            flex: 0.25;
            transition: all 0.15s;
        }

        .btn-test.testing {
            background: #e94560;
            color: #fff;
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.5);
        }

        /* Alarm overlay */
        .alarm-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(233, 69, 96, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: alarmFlash 0.5s infinite;
        }

        .alarm-overlay.active {
            display: flex;
        }

        @keyframes alarmFlash {
            0%, 100% { background: rgba(233, 69, 96, 0.95); }
            50% { background: rgba(233, 69, 96, 0.7); }
        }

        .alarm-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .alarm-text {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .alarm-subtext {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 40px;
            text-align: center;
            padding: 0 20px;
        }

        .btn-dismiss {
            padding: 16px 60px;
            background: #fff;
            color: #e94560;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* Instructions overlay */
        .instructions {
            position: absolute;
            bottom: 200px;
            left: 10px;
            right: 10px;
            z-index: 999;
            background: rgba(22, 33, 62, 0.9);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            backdrop-filter: blur(10px);
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .instructions.hidden {
            opacity: 0;
        }

        .instructions p {
            font-size: 14px;
            color: #888;
            line-height: 1.5;
        }

        .instructions strong {
            color: #4ecca3;
        }

        /* Keep screen awake notice */
        .awake-notice {
            font-size: 11px;
            color: #555;
            text-align: center;
            margin-top: 8px;
        }

        /* Dim overlay while tracking */
        .dim-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 5000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .dim-overlay.active {
            display: flex;
        }

        .dim-info {
            text-align: center;
            color: rgba(255,255,255,0.3);
        }

        .dim-distance {
            font-size: 48px;
            font-weight: 700;
            color: rgba(78, 204, 163, 0.6);
        }

        .dim-distance .dim-unit {
            font-size: 18px;
            font-weight: 400;
        }

        .dim-hint {
            font-size: 12px;
            margin-top: 16px;
            color: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>Wake<span>Stop</span></h1>
        </div>
        <div class="header-controls">
            <button class="unit-toggle active" id="unitToggle">mi</button>
            <div class="status-dot" id="statusDot"></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="search-container">
        <input type="text" class="search-box" id="searchBox" placeholder="Search for a destination..." autocomplete="off">
        <div class="search-results" id="searchResults"></div>
    </div>

    <div class="favourites-bar" id="favouritesBar"></div>

    <div class="instructions" id="instructions">
        <p><strong>Search</strong> for a place or <strong>tap the map</strong> to set your destination, then hit <strong>Start</strong>.</p>
    </div>

    <div class="bottom-panel">
        <div class="dest-info" id="destInfo">
            <div class="dest-header">
                <div class="dest-name" id="destName">--</div>
                <button class="btn-save-fav" id="btnSaveFav" title="Save to favourites">&#9734;</button>
            </div>
            <div class="dest-distance" id="destDistance">-- <span class="unit">away</span></div>
        </div>

        <div class="radius-control">
            <div class="radius-label">
                <span>Alert when within:</span>
                <span class="radius-value" id="radiusValue">1.0 mi</span>
            </div>
            <input type="range" class="radius-slider" id="radiusSlider" min="0.1" max="5" step="0.1" value="1.0">
            <div class="radius-presets" id="radiusPresets">
                <button class="preset-btn" data-value="0.25">0.25</button>
                <button class="preset-btn" data-value="0.5">0.5</button>
                <button class="preset-btn active" data-value="1">1</button>
                <button class="preset-btn" data-value="2">2</button>
                <button class="preset-btn" data-value="5">5</button>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-clear" id="btnClear">Clear</button>
            <button class="btn btn-test" id="btnTest">Test Alarm</button>
            <button class="btn btn-start" id="btnStart" disabled>Pick a stop</button>
            <button class="btn btn-stop" id="btnStop">Stop</button>
        </div>
        <div class="awake-notice" id="awakeNotice"></div>
    </div>

    <div class="alarm-overlay" id="alarmOverlay">
        <div class="alarm-icon">&#128694;</div>
        <div class="alarm-text">WAKE UP!</div>
        <div class="alarm-subtext" id="alarmSubtext">You're near your stop!</div>
        <button class="btn-dismiss" id="btnDismiss">I'm Awake!</button>
    </div>

    <div class="dim-overlay" id="dimOverlay">
        <div class="dim-info">
            <div class="dim-distance" id="dimDistance">-- <span class="dim-unit">mi</span></div>
            <div class="dim-hint">Tap to brighten</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===================== STATE =====================
        let map, userMarker, destMarker, radiusCircle;
        let destination = null;       // { lat, lng, name }
        let alertRadius = 1.0;        // always stored in miles internally
        let useMetric = false;        // false = miles, true = km
        let tracking = false;
        let watchId = null;
        let alarmActive = false;
        let alarmSound = null;
        let wakeLock = null;
        let searchTimeout = null;
        let dimmed = false;
        let favourites = JSON.parse(localStorage.getItem('wakestop_favs') || '[]');

        // ===================== UNIT HELPERS =====================
        function displayDist(miles) {
            if (useMetric) return (miles * 1.60934).toFixed(2);
            return miles.toFixed(2);
        }

        function displayUnit() {
            return useMetric ? 'km' : 'mi';
        }

        function displayRadius(miles) {
            if (useMetric) return (miles * 1.60934).toFixed(1);
            return miles.toFixed(1);
        }

        // ===================== INIT MAP =====================
        map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([51.505, -0.09], 13);

        // CartoDB Voyager - clean, slightly colourful style
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        // Try to center on user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    map.setView([pos.coords.latitude, pos.coords.longitude], 14);
                },
                () => {},
                { enableHighAccuracy: true }
            );
        }

        // ===================== MAP TAP =====================
        map.on('click', function(e) {
            if (tracking) return;
            // Reverse geocode to get a real place name
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        async function reverseGeocode(lat, lng) {
            // Set a temporary name immediately so the UI is responsive
            setDestination(lat, lng, 'Loading...');
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=14`);
                const data = await res.json();
                if (data && data.address) {
                    const addr = data.address;
                    // Pick the best human-readable name
                    const name = addr.village || addr.town || addr.city || addr.suburb ||
                                 addr.hamlet || addr.neighbourhood || addr.county ||
                                 data.display_name.split(',')[0];
                    destination.name = name;
                    document.getElementById('destName').textContent = name;
                    searchBox.value = name;
                }
            } catch (err) {
                // Keep coordinate fallback if reverse geocode fails
                const fallback = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                destination.name = fallback;
                document.getElementById('destName').textContent = fallback;
            }
        }

        // ===================== SEARCH =====================
        const searchBox = document.getElementById('searchBox');
        const searchResults = document.getElementById('searchResults');

        searchBox.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            if (query.length < 3) {
                searchResults.classList.remove('visible');
                return;
            }
            searchTimeout = setTimeout(() => searchPlaces(query), 400);
        });

        searchBox.addEventListener('focus', function() {
            if (searchResults.children.length > 0) {
                searchResults.classList.add('visible');
            }
        });

        async function searchPlaces(query) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                const data = await res.json();
                searchResults.innerHTML = '';
                if (data.length === 0) {
                    searchResults.classList.remove('visible');
                    return;
                }
                data.forEach(place => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = place.display_name;
                    item.addEventListener('click', () => {
                        const name = place.display_name.split(',')[0];
                        setDestination(parseFloat(place.lat), parseFloat(place.lon), name);
                        searchResults.classList.remove('visible');
                        searchBox.value = name;
                        searchBox.blur();
                    });
                    searchResults.appendChild(item);
                });
                searchResults.classList.add('visible');
            } catch (err) {
                console.error('Search failed:', err);
            }
        }

        // Close search results when tapping elsewhere
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('visible');
            }
        });

        // ===================== SET DESTINATION =====================
        function setDestination(lat, lng, name) {
            destination = { lat, lng, name };

            // Marker
            if (destMarker) map.removeLayer(destMarker);
            destMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: '',
                    html: '<div style="background:#e94560;width:16px;height:16px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(map);

            updateRadiusCircle();
            map.setView([lat, lng], 14);

            // Update UI
            document.getElementById('destName').textContent = name;
            document.getElementById('destInfo').classList.add('visible');
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').textContent = 'Start';
            document.getElementById('instructions').classList.add('hidden');
            updateFavButton();
        }

        function updateRadiusCircle() {
            if (!destination) return;
            if (radiusCircle) map.removeLayer(radiusCircle);
            radiusCircle = L.circle([destination.lat, destination.lng], {
                radius: alertRadius * 1609.34,
                color: '#e94560',
                fillColor: '#e94560',
                fillOpacity: 0.15,
                weight: 3,
                dashArray: '8, 6'
            }).addTo(map);
        }

        // ===================== RADIUS SLIDER =====================
        const radiusSlider = document.getElementById('radiusSlider');
        const radiusValueEl = document.getElementById('radiusValue');

        radiusSlider.addEventListener('input', function() {
            alertRadius = parseFloat(this.value);
            radiusValueEl.textContent = displayRadius(alertRadius) + ' ' + displayUnit();
            updateRadiusCircle();
            updatePresetHighlight();
        });

        // ===================== RADIUS PRESETS =====================
        const presetBtns = document.querySelectorAll('.preset-btn');
        presetBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                alertRadius = parseFloat(this.dataset.value);
                radiusSlider.value = alertRadius;
                radiusValueEl.textContent = displayRadius(alertRadius) + ' ' + displayUnit();
                updateRadiusCircle();
                updatePresetHighlight();
            });
        });

        function updatePresetHighlight() {
            presetBtns.forEach(btn => {
                const val = parseFloat(btn.dataset.value);
                btn.classList.toggle('active', Math.abs(val - alertRadius) < 0.01);
            });
        }

        function updatePresetLabels() {
            presetBtns.forEach(btn => {
                const miles = parseFloat(btn.dataset.value);
                btn.textContent = displayRadius(miles);
            });
        }

        // ===================== UNIT TOGGLE =====================
        document.getElementById('unitToggle').addEventListener('click', function() {
            useMetric = !useMetric;
            this.textContent = useMetric ? 'km' : 'mi';

            // Update slider max for metric (8 km ~ 5 mi)
            radiusValueEl.textContent = displayRadius(alertRadius) + ' ' + displayUnit();
            updatePresetLabels();

            // Update distance display if destination set
            if (destination) {
                const distEl = document.getElementById('destDistance');
                const currentText = distEl.textContent;
                if (currentText.includes('--')) {
                    // Not tracking yet, no distance to update
                } else {
                    // Will be updated on next GPS tick
                }
            }
        });

        // ===================== FAVOURITES =====================
        function renderFavourites() {
            const bar = document.getElementById('favouritesBar');
            bar.innerHTML = '';
            favourites.forEach((fav, i) => {
                const chip = document.createElement('div');
                chip.className = 'fav-chip';
                chip.innerHTML = `${fav.name} <span class="fav-remove" data-index="${i}">&times;</span>`;
                chip.addEventListener('click', function(e) {
                    if (e.target.classList.contains('fav-remove')) {
                        favourites.splice(parseInt(e.target.dataset.index), 1);
                        localStorage.setItem('wakestop_favs', JSON.stringify(favourites));
                        renderFavourites();
                        updateFavButton();
                        return;
                    }
                    if (!tracking) {
                        setDestination(fav.lat, fav.lng, fav.name);
                        searchBox.value = fav.name;
                    }
                });
                bar.appendChild(chip);
            });
        }

        function updateFavButton() {
            const btn = document.getElementById('btnSaveFav');
            if (!destination) {
                btn.classList.remove('saved');
                btn.innerHTML = '&#9734;';
                return;
            }
            const isSaved = favourites.some(f =>
                Math.abs(f.lat - destination.lat) < 0.001 &&
                Math.abs(f.lng - destination.lng) < 0.001
            );
            btn.classList.toggle('saved', isSaved);
            btn.innerHTML = isSaved ? '&#9733;' : '&#9734;';
        }

        document.getElementById('btnSaveFav').addEventListener('click', function() {
            if (!destination) return;
            const idx = favourites.findIndex(f =>
                Math.abs(f.lat - destination.lat) < 0.001 &&
                Math.abs(f.lng - destination.lng) < 0.001
            );
            if (idx >= 0) {
                favourites.splice(idx, 1);
            } else {
                favourites.push({ lat: destination.lat, lng: destination.lng, name: destination.name });
            }
            localStorage.setItem('wakestop_favs', JSON.stringify(favourites));
            renderFavourites();
            updateFavButton();
        });

        renderFavourites();

        // ===================== DISTANCE CALC =====================
        function getDistanceMiles(lat1, lon1, lat2, lon2) {
            const R = 3958.8;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ===================== TRACKING =====================
        function startTracking() {
            if (!destination) return;
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }

            tracking = true;
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            document.getElementById('statusDot').classList.add('tracking');
            radiusSlider.disabled = true;
            document.querySelectorAll('.preset-btn').forEach(b => b.disabled = true);

            requestWakeLock();

            watchId = navigator.geolocation.watchPosition(
                pos => {
                    const { latitude, longitude } = pos.coords;

                    // Update user marker
                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.circleMarker([latitude, longitude], {
                        radius: 8,
                        fillColor: '#4285f4',
                        fillOpacity: 1,
                        color: '#fff',
                        weight: 3
                    }).addTo(map);

                    // Calculate distance
                    const distMiles = getDistanceMiles(latitude, longitude, destination.lat, destination.lng);
                    const distDisplay = displayDist(distMiles);
                    const unit = displayUnit();

                    document.getElementById('destDistance').innerHTML =
                        distDisplay + ' <span class="unit">' + unit + ' away</span>';

                    // Update page title
                    document.title = distDisplay + ' ' + unit + ' - WakeStop';

                    // Update dim overlay distance
                    document.getElementById('dimDistance').innerHTML =
                        distDisplay + ' <span class="dim-unit">' + unit + '</span>';

                    // Check if within radius
                    if (distMiles <= alertRadius && !alarmActive) {
                        triggerAlarm(distMiles);
                    }
                },
                err => {
                    console.error('Geolocation error:', err);
                    alert('Unable to access your location. Please enable location services.');
                    stopTracking();
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 5000,
                    timeout: 15000
                }
            );

            // Show dim option after a few seconds
            setTimeout(() => {
                if (tracking) {
                    document.getElementById('awakeNotice').textContent =
                        'Screen stays on while tracking. Tap the map to dim.';
                }
            }, 3000);
        }

        function stopTracking() {
            tracking = false;
            dimmed = false;
            document.getElementById('dimOverlay').classList.remove('active');
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            document.getElementById('btnStart').style.display = 'block';
            document.getElementById('btnStop').style.display = 'none';
            document.getElementById('statusDot').classList.remove('tracking');
            radiusSlider.disabled = false;
            document.querySelectorAll('.preset-btn').forEach(b => b.disabled = false);
            releaseWakeLock();
            document.title = 'WakeStop - Proximity Alarm';
        }

        // ===================== DIM MODE =====================
        map.getContainer().addEventListener('click', function(e) {
            if (tracking && !alarmActive) {
                dimmed = true;
                document.getElementById('dimOverlay').classList.add('active');
            }
        });

        document.getElementById('dimOverlay').addEventListener('click', function() {
            dimmed = false;
            this.classList.remove('active');
        });

        // ===================== ALARM =====================
        function triggerAlarm(dist) {
            alarmActive = true;
            dimmed = false;
            document.getElementById('dimOverlay').classList.remove('active');
            document.getElementById('statusDot').classList.remove('tracking');
            document.getElementById('statusDot').classList.add('alarm');

            const distDisplay = displayDist(dist);
            const unit = displayUnit();
            document.getElementById('alarmSubtext').textContent =
                `You're ${distDisplay} ${unit} from ${destination.name}`;
            document.getElementById('alarmOverlay').classList.add('active');

            playAlarm();

            if (navigator.vibrate) {
                navigator.vibrate([500, 200, 500, 200, 500, 200, 500, 200, 500, 200, 500]);
            }
        }

        function dismissAlarm() {
            alarmActive = false;
            document.getElementById('alarmOverlay').classList.remove('active');
            document.getElementById('statusDot').classList.remove('alarm');
            stopAlarm();
            stopTracking();
        }

        // ===================== ALARM SOUND =====================
        let alarmInterval = null;

        function playAlarm() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                alarmSound = audioCtx;

                function scheduleBeeps() {
                    let t = audioCtx.currentTime;
                    for (let i = 0; i < 30; i++) {
                        // Loud, urgent two-tone siren
                        createBeep(audioCtx, t, 880, 0.5);
                        t += 0.3;
                        createBeep(audioCtx, t, 660, 0.5);
                        t += 0.3;
                    }
                }

                function createBeep(ctx, startTime, freq, vol) {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'square';
                    gain.gain.setValueAtTime(vol, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.25);
                    osc.start(startTime);
                    osc.stop(startTime + 0.25);
                }

                scheduleBeeps();
                // Keep rescheduling so it doesn't stop
                alarmInterval = setInterval(() => {
                    if (alarmActive) scheduleBeeps();
                }, 15000);
            } catch(e) {
                console.error('Audio failed:', e);
            }
        }

        function stopAlarm() {
            if (alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
            if (alarmSound) {
                try { alarmSound.close(); } catch(e) {}
                alarmSound = null;
            }
        }

        // ===================== TEST ALARM =====================
        document.getElementById('btnTest').addEventListener('click', function() {
            const btn = this;
            btn.classList.add('testing');
            btn.textContent = 'TESTING...';

            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                let t = audioCtx.currentTime;
                for (let i = 0; i < 4; i++) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = i % 2 === 0 ? 880 : 660;
                    osc.type = 'square';
                    gain.gain.setValueAtTime(0.5, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.25);
                    osc.start(t);
                    osc.stop(t + 0.25);
                    t += 0.3;
                }
                if (navigator.vibrate) {
                    navigator.vibrate([300, 100, 300]);
                }
                setTimeout(() => {
                    audioCtx.close();
                    btn.classList.remove('testing');
                    btn.textContent = 'Test Alarm';
                }, 1500);
            } catch(e) {
                console.error('Test audio failed:', e);
                btn.classList.remove('testing');
                btn.textContent = 'Test Alarm';
            }
        });

        // ===================== WAKE LOCK =====================
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('awakeNotice').textContent = 'Screen will stay on while tracking';
                }
            } catch (err) {
                console.log('Wake lock not available:', err);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
            document.getElementById('awakeNotice').textContent = '';
        }

        document.addEventListener('visibilitychange', () => {
            if (tracking && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });

        // ===================== BUTTON HANDLERS =====================
        document.getElementById('btnStart').addEventListener('click', startTracking);
        document.getElementById('btnStop').addEventListener('click', stopTracking);
        document.getElementById('btnDismiss').addEventListener('click', dismissAlarm);

        document.getElementById('btnClear').addEventListener('click', function() {
            if (tracking) return;
            destination = null;
            if (destMarker) { map.removeLayer(destMarker); destMarker = null; }
            if (radiusCircle) { map.removeLayer(radiusCircle); radiusCircle = null; }
            document.getElementById('destInfo').classList.remove('visible');
            document.getElementById('destName').textContent = '--';
            document.getElementById('destDistance').innerHTML = '-- <span class="unit">away</span>';
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStart').textContent = 'Pick a stop';
            document.getElementById('instructions').classList.remove('hidden');
            searchBox.value = '';
            updateFavButton();
        });
    </script>
</body>
</html>
